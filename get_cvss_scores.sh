#!/bin/bash
CSVFILE="nmap_vulnerabilitis.csv"

rm -f $CSVFILE
touch $CSVFILE

for IP in ${1}/*; do
	
	IPNO=`basename "$IP"`
	echo $IPNO

	foo=`grep -noP "\d{2,5}/" $IP | cut -d: -f1` # Get line numbers for ports.
	line_no=( $foo ) # Put line numbers into array

	last_arg=`expr ${#line_no[@]} - 1` # Get index of last item in array.

	for i in `seq 0 $last_arg`; do
		next=`expr $i + 1` 					# Get i + 1
		begin=${line_no[$i]} 				# Store first line number
		end=${line_no[$next]} 				# Store last line number
		if [ -z $end ]; then end=10000; fi 	# If no line number, make default 10000 (Most likely eof)
		end=`expr $end - 1` 				# Don't include last line
		line_range="${begin},${end}p"		# Set line range for sed command
		
		lines=`sed -n $line_range $IP` 	# Get lines
		PORT=`echo $lines | grep -oP "\d{2,5}/" | sed 's/\///'` # Get port number
		echo $lines | grep -oP "CVE-\d{4}-\d{4,5}\s\d\.\d\s[a-z/:\.]*\.com" | while read -r line
		do
			CVE_ID=`echo $line | grep -oP "CVE-\d{4}-\d{2,5}"`
			CVSS_SCORE=`echo $line | grep -oP "\d\.\d"` # Get vulnerability score
			echo  "${IPNO};${PORT};${CVE_ID};${CVSS_SCORE}" >> $CSVFILE #Append all scores to vulnerability file
		done
	done

done




